<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#7c4dff">
  <meta name="description" content="计件工资记账应用 - 离线使用，本地存储">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>计件工资记账</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icons/icon-192.svg">
  <link rel="apple-touch-icon" href="./icons/icon-192.svg">
  <link rel="stylesheet" href="./styles.css">
</head>

<body>

  <!-- ========== Tab 1: 记账（默认首页） ========== -->
  <div class="content">
    <div id="tab-record" class="tab-content active">
      <!-- 项目切换栏 -->
      <div class="project-bar" id="project-bar">
        <button class="project-chip active" data-project="" onclick="selectProject(this)">全部</button>
        <!-- 项目按钮由 JS 动态生成 -->
      </div>

      <!-- 无项目提示 -->
      <div id="empty-hint" class="empty-hint" style="display:none;">
        <div class="empty-icon">📂</div>
        <p>还没有项目</p>
        <p class="sub">请先到「管理」页面添加项目和工作内容</p>
        <button class="btn btn-primary" onclick="switchTab('settings')" style="margin-top:16px;max-width:200px;">
          去添加 →
        </button>
      </div>

      <!-- 工作内容卡片网格 -->
      <div id="work-cards" class="work-cards"></div>

      <!-- 今日记录摘要 -->
      <div id="today-summary" class="today-summary" style="display:none;">
        <div class="today-title">📋 今日已记</div>
        <div id="today-list"></div>
      </div>
    </div>

    <!-- ========== Tab 2: 统计 ========== -->
    <div id="tab-stats" class="tab-content">
      <!-- 筛选 -->
      <div class="card" style="padding:14px;">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
          <input type="date" id="stat-start" onchange="refreshStats();refreshHistory();"
            style="flex:1;background:var(--bg-input);border:1px solid rgba(124,77,255,0.15);border-radius:8px;color:var(--text-primary);padding:10px;font-size:15px;">
          <span style="color:var(--text-secondary);font-size:14px;">至</span>
          <input type="date" id="stat-end" onchange="refreshStats();refreshHistory();"
            style="flex:1;background:var(--bg-input);border:1px solid rgba(124,77,255,0.15);border-radius:8px;color:var(--text-primary);padding:10px;font-size:15px;">
        </div>
        <div style="display:flex;gap:8px;">
          <select id="filter-project" onchange="refreshStats();refreshHistory();"
            style="flex:1;background:var(--bg-input);border:1px solid rgba(124,77,255,0.15);border-radius:8px;color:var(--text-primary);padding:10px;font-size:15px;-webkit-appearance:none;appearance:none;">
            <option value="">全部项目</option>
          </select>
          <select id="filter-worker" onchange="refreshStats();refreshHistory();"
            style="flex:1;background:var(--bg-input);border:1px solid rgba(124,77,255,0.15);border-radius:8px;color:var(--text-primary);padding:10px;font-size:15px;-webkit-appearance:none;appearance:none;">
            <option value="">全部工人</option>
          </select>
        </div>
      </div>

      <!-- 总览卡片 -->
      <div class="summary-cards">
        <div class="summary-card">
          <div class="value" id="summary-amount">¥0.00</div>
          <div class="label">总金额</div>
        </div>
        <div class="summary-card">
          <div class="value" id="summary-count">0</div>
          <div class="label">工人数</div>
        </div>
        <div class="summary-card">
          <div class="value" id="summary-qty">0</div>
          <div class="label">总数量</div>
        </div>
        <div class="summary-card">
          <div class="value" id="summary-items">0</div>
          <div class="label">工作项</div>
        </div>
      </div>

      <!-- 按工人统计 -->
      <div class="card">
        <div class="card-title">👷 按工人统计</div>
        <table class="stat-table">
          <thead>
            <tr>
              <th>工人</th>
              <th>数量</th>
              <th>金额</th>
            </tr>
          </thead>
          <tbody id="worker-stats-body">
            <tr>
              <td colspan="3" class="stat-empty">暂无数据</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 按工作内容统计 -->
      <div class="card">
        <div class="card-title">📦 按工作内容统计</div>
        <table class="stat-table">
          <thead>
            <tr>
              <th>内容</th>
              <th>数量</th>
              <th>金额</th>
            </tr>
          </thead>
          <tbody id="content-stats-body">
            <tr>
              <td colspan="3" class="stat-empty">暂无数据</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 按工作内容×工人明细 -->
      <div class="card">
        <div class="card-title">🔍 工作内容 × 工人明细</div>
        <div id="content-worker-stats">
          <div class="stat-empty">暂无数据</div>
        </div>
      </div>

      <!-- 历史记录 -->
      <div class="card">
        <div class="card-title">📜 记录明细</div>
      </div>
      <div id="record-list"></div>
    </div>

    <!-- ========== Tab 3: 管理 ========== -->
    <div id="tab-settings" class="tab-content">
      <!-- 项目管理 -->
      <div class="card">
        <div class="card-title">📂 项目管理</div>
        <div id="project-list"></div>
        <div class="add-row">
          <input type="text" id="new-project-name" placeholder="输入项目名称" onkeydown="if(event.key==='Enter')addProject()">
          <button class="btn btn-primary btn-small" onclick="addProject()">添加</button>
        </div>
      </div>

      <!-- 工作内容管理 -->
      <div class="card">
        <div class="card-title">📋 工作内容管理</div>
        <div class="form-group" style="margin-bottom:12px;">
          <select id="wi-project" onchange="onWiProjectChange()">
            <option value="">请选择项目</option>
          </select>
        </div>
        <div id="wi-list">
          <div class="stat-empty">请先选择项目</div>
        </div>
        <div class="add-row" style="margin-top:12px;">
          <input type="text" id="wi-content-name" placeholder="工作内容名称">
        </div>
        <div class="add-row" style="margin-top:8px;">
          <input type="number" id="wi-unit-price" inputmode="decimal" step="any" min="0" placeholder="单价（元）">
          <button class="btn btn-primary btn-small" onclick="addWorkItem()">添加</button>
        </div>
      </div>

      <!-- 工人管理 -->
      <div class="card">
        <div class="card-title">👷 工人管理</div>
        <div id="worker-list"></div>
        <div class="add-row">
          <input type="text" id="new-worker-name" placeholder="输入工人姓名" onkeydown="if(event.key==='Enter')addWorker()">
          <button class="btn btn-primary btn-small" onclick="addWorker()">添加</button>
        </div>
      </div>

      <!-- 数据导入导出 -->
      <div class="card">
        <div class="card-title">📥 数据导入导出</div>
        <div class="form-group" style="margin-bottom:12px;">
          <select id="export-project">
            <option value="">全部项目</option>
          </select>
        </div>
        <button class="btn btn-outline" onclick="exportData()" style="margin-bottom:10px;">📥 导出 CSV 文件</button>
        <button class="btn btn-outline" onclick="document.getElementById('import-file').click()">📤 导入 CSV 文件</button>
        <input type="file" id="import-file" accept=".csv" style="display:none;" onchange="importCSV(event)">
        <p style="font-size:14px;color:var(--text-secondary);margin-top:10px;">
          导入格式需与导出的 CSV 格式一致
        </p>
      </div>

      <!-- 清除缓存 -->
      <div class="card">
        <div class="card-title">🔄 更新应用</div>
        <p style="font-size:16px;color:var(--text-secondary);margin-bottom:14px;">
          如果页面显示异常，点击下方按钮清除缓存后刷新
        </p>
        <button class="btn btn-danger" onclick="clearCache()">🗑️ 清除缓存并刷新</button>
      </div>
    </div>
  </div>

  <!-- ========== 快速记账弹窗（简化版） ========== -->
  <div class="modal-overlay" id="record-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-title">记账</h2>
        <button class="modal-close" onclick="closeModal()">✕</button>
      </div>
      <form id="record-form" onsubmit="event.preventDefault();saveRecord();">
        <input type="hidden" id="record-id">
        <input type="hidden" id="record-project">
        <input type="hidden" id="record-content">
        <input type="hidden" id="record-price-hidden">

        <!-- 工作内容显示（只读） -->
        <div class="selected-work-info" id="selected-work-info">
          <span class="work-label" id="work-label">裁剪</span>
          <span class="work-price" id="work-price">¥5.50/件</span>
        </div>

        <!-- 日期 -->
        <div class="form-group">
          <label>📅 日期</label>
          <input type="date" id="record-date" required>
        </div>

        <!-- 选择工人（大按钮，不是下拉框） -->
        <div class="form-group">
          <label>👷 选择工人</label>
          <div id="worker-buttons" class="worker-buttons"></div>
        </div>

        <!-- 数量 -->
        <div class="form-group">
          <label>📦 数量</label>
          <input type="number" id="record-qty" inputmode="decimal" step="any" min="0" placeholder="输入数量" required
            oninput="calcTotal()" style="font-size:22px;text-align:center;padding:16px;">
        </div>

        <!-- 总价 -->
        <div class="total-display" id="calc-total">¥0.00</div>

        <button type="submit" class="btn btn-primary" id="save-btn" style="margin-top:16px;">
          ✅ 保存
        </button>
      </form>
    </div>
  </div>

  <!-- Toast 提示 -->
  <div class="toast" id="toast"></div>

  <!-- 确认弹窗 -->
  <div class="confirm-overlay" id="confirm-overlay">
    <div class="confirm-box">
      <p id="confirm-msg">确定要删除吗？</p>
      <div class="btn-row">
        <button class="btn btn-outline btn-small" onclick="closeConfirm()">取消</button>
        <button class="btn btn-danger btn-small" id="confirm-yes" onclick="executeDelete()">确定删除</button>
      </div>
    </div>
  </div>

  <!-- 底部导航栏 -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-tab="record" onclick="switchTab('record')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 20h9" />
        <path d="M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z" />
      </svg>
      记账
    </button>
    <button class="nav-item" data-tab="stats" onclick="switchTab('stats')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="20" x2="18" y2="10" />
        <line x1="12" y1="20" x2="12" y2="4" />
        <line x1="6" y1="20" x2="6" y2="14" />
      </svg>
      统计
    </button>
    <button class="nav-item" data-tab="settings" onclick="switchTab('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3" />
        <path
          d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z" />
      </svg>
      管理
    </button>
  </nav>

  <script src="./db.js"></script>
  <script src="./app.js"></script>

</body>

</html>